<?php
/**
 * Created by PhpStorm.
 * User: aboussadia
 * Date: 17/04/2018
 * Time: 10:13
 */

namespace ExploitBundle\Repository;


class IntegRepository
{
    /**
     * @return resource
     */
    public function  connexion_gce()
    {

        $db_gce = "(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=192.168.11.35)(PORT=1521))(CONNECT_DATA=(SID=GNX)))";
        $conn = oci_connect('soc2', 'recette', $db_gce);

        $req_format_date = oci_parse($conn, "ALTER SESSION SET NLS_DATE_FORMAT='DD-MON-YYYY HH24:MI:SS'");
        oci_execute($req_format_date);

        return $conn;

        oci_close($conn);

    }


    /**
     * @param $codpro
     * @param $date
     * @param $sql
     * @return int
     * verifier s'il un produit existe
     */
    public function checkCodproTsc($codpro, $date, $fou,  $sql){

        $this->connexion_gce();

        //echo "select * from  tsc where CODSOC=1 and CODPRO ='". $codpro ."' and DATDEB ='".$date ."' $sql";
        $req_gce_fil = oci_parse($this->connexion_gce(), "select * from  tsc where CODSOC=1 and CODPRO ='". $codpro ."' and DATDEB ='".$date ."' $sql");
        $res_req =  oci_execute($req_gce_fil);
        $row = oci_fetch_all($req_gce_fil, $res_req, null, null, OCI_FETCHSTATEMENT_BY_ROW);
        return $row;  // retourn 1 ou 0
    }

    /**
     * @param $fou numéro fournisseur fourni
     * @return int 1 s'il existe, 0 s'il n'existe pas
     * Cette fonction verifie si le numéro fournisseur existe ou pas
     */
    public function checkFouPrc($fou){
        $this->connexion_gce();

        $req_gce_fil = oci_parse($this->connexion_gce(), "select * from  prc where CODSOC=1 AND TYPTIE = 'FOU'and SIGFOU ='". $fou ."'");
        $res_req =  oci_execute($req_gce_fil);
        $row = oci_fetch_all($req_gce_fil, $res_req, null, null, OCI_FETCHSTATEMENT_BY_ROW);

        return $row;
    }

    /**
     * @param $codpro
     * @param $date
     * @param $sql
     * @return int
     * verifie si un produit existe (donc même ACHVTE + CODPRO + DATDEB + SIGTIE mais different prix)
     */
    public function checkPrxtarTsc($codpro, $date, $fou,  $sql){

        $this->connexion_gce();

        $req_gce_fil = oci_parse($this->connexion_gce(), "select * from  tsc where CODSOC=1 and CODPRO ='". $codpro ."' and DATDEB ='".$date ."' $sql");
        //echo '<br>'."req_gce_fil: {". $req_gce_fil .'}'.'<br>';
        $res_req =  oci_execute($req_gce_fil);
        //echo "res_req: {". $res_req .'}'.'<br>';
        $row = oci_fetch_all($req_gce_fil, $res_req, null, null, OCI_FETCHSTATEMENT_BY_ROW);
        //echo '<br>';
        //echo "row: {". $row .'}'.'<br>';

        return $row;  // retourn 1 ou 0
    }

    /**
     * @param $sode_str
     * @param $date
     * @param $pa_pv
     * @param $fou
     * @param $typeInser
     * @return bool
     * insertion des produit dans tsc
     */
    public function insertProduits($sode_str, $date, $pa_pv, $fou, $typeInser){
        $this->connexion_gce();
        if($pa_pv == 'PA'){
            $sql_insert ="insert into tsc (codsoc,achvte,sigtie,codpro,coddev,datdeb,tarcol,prxtar,datmod,utimod,codreg,codetb,codbar,codvar,coduni,datfin,prxrev,marge)
                          select '1','".$typeInser."','".$fou."','".$sode_str."','EUR','".$date."','N',$pa_pv,to_char(sysdate,'YYYYMMDD'),'GNX',' ',' ',' ',' ','U',' ' ,0,0 
                           FROM PRC WHERE  codsoc = 1 AND typtie = 'FOU' AND sigfou = '".$fou."' AND codpro = '".$sode_str."' ";
        }else{
            $sql_insert ="insert into tsc (codsoc,achvte,sigtie,codpro,coddev,datdeb,tarcol,prxtar,datmod,utimod,codreg,codetb,codbar,codvar,coduni,datfin,prxrev,marge) select '1','".$typeInser."','".$fou."','".$sode_str."','EUR','".$date."','N',$pa_pv,to_char(sysdate,'YYYYMMDD'),'GNX',' ',' ',' ',' ','U',' ' ,0,0 from dual";
        }
        $req_gce_fil = oci_parse($this->connexion_gce(),$sql_insert);
        oci_execute($req_gce_fil);

        return true;
    }

    /**
     * @param $sode_str
     * @param $date
     * @param $pa_pv
     * @param $fou
     * @param $typeInser
     * @return bool
     * Update d'un produit (seulement la colonne prix)
     */
    public function updateProduits($sode_str, $date, $pa_pv, $fou, $typeInser, $prxtar){
        $this->connexion_gce();

        $sql_update ="UPDATE tsc SET prxtar = '". $prxtar. "', DATMOD = to_char(sysdate,'YYYYMMDD') WHERE CODPRO ='". $sode_str ."' and DATDEB ='". $date. "'";

        $req_gce_fil = oci_parse($this->connexion_gce(),$sql_update);
        oci_execute($req_gce_fil);

        return true;
    }

}