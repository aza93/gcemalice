<?php
/**
 * Created by PhpStorm.
 * User: aboussadia
 * Date: 03/07/2018
 * Time: 16:14
 */

namespace ExploitBundle\Controller;


use ExploitBundle\Resources\config\Connexion;
use Sensio\Bundle\FrameworkExtraBundle\Configuration\Route;
use Symfony\Bundle\FrameworkBundle\Controller\Controller;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\HttpFoundation\Session\Session;
use ExploitBundle\Repository\RequegceRepository;
use Sensio\Bundle\FrameworkExtraBundle\Configuration\Security;

class GceappController extends Controller
{
    /**
     * @return \Symfony\Component\HttpFoundation\Response
     * @Route("/gce/app", name="formgce_gce")
     * @Security("has_role('ROLE_ADMIN')")
     */
    public function newAction(Request $request, Session $session)
    {

//        $session->getFlashBag()->add('success', "Gestion des procedures GCE ");
        $form           = $this->createForm('ExploitBundle\Form\GceappType');
        $form_renvoicmd = $this->createForm('ExploitBundle\Form\GceapprenvoicmdType');
        $form_impre = $this->createForm('ExploitBundle\Form\ImpressionetiquType');
        $form->handleRequest($request);
        $form_renvoicmd->handleRequest($request);
        $form_impre->handleRequest($request);

        //Supprimer NCF
        if ($form->isSubmitted() && $form->isValid()) {
          $ncf_supp =  $form->getData();
          $num_ncf = $ncf_supp["numncf"];
          $congce = new RequegceRepository;

            $congce->supprimencf($num_ncf);

            $session->getFlashBag()->add('success', "Vous pouvez supprimer la NCF sur GCE.");

            return $this->render("Gceapp/new.html.twig", array(
                'form' => $form->createView(),
                'form_renvoicmd' => $form_renvoicmd->createView(),
                'form_impre' => $form_impre->createView()
            ));


        }

        // Renvoi commande Email
        if ($form_renvoicmd->isSubmitted() && $form_renvoicmd->isValid()) {   //Formulaire renvoi de commande EDI

            $cmd_revoi = $form_renvoicmd->getData();
            $cmd = $cmd_revoi['cmdrenvoi'];
            $congce = new RequegceRepository;
            $congce->updaterenvoicmd($cmd);

            $session->getFlashBag()->add('success', "LA COMMANDE : $cmd  VIENT D'ETRE RENVOYEE  ");

            return $this->render("Gceapp/new.html.twig", array(
                'form' => $form->createView(),
                'form_renvoicmd' => $form_renvoicmd->createView(),
                'form_impre' => $form_impre->createView()
            ));

        }
        // impression etiquette magasin
        if ($form_impre->isSubmitted() && $form_impre->isValid()) {
            $impr_mag =  $form_impre->getData();
            $mag = $impr_mag['edimag'];
            $congce = new RequegceRepository;

            $congce->impressionetiquetmag($mag);

            $session->getFlashBag()->add('success', "Lancement des etiquette sur le magasin  : $mag  vient d'etre effectuÃ©  ");

            return $this->render("Gceapp/new.html.twig", array(
                'form' => $form->createView(),
                'form_renvoicmd' => $form_renvoicmd->createView(),
                'form_impre' => $form_impre->createView()
            ));


        }


        return $this->render("Gceapp/new.html.twig", array(

            'form' => $form->createView(),
            'form_renvoicmd' => $form_renvoicmd->createView(),
            'form_impre' => $form_impre->createView()
        ));

    }

    /**
     * @return \Symfony\Component\HttpFoundation\Response
     * @Route("/gce/ncfsupp", name="ncfsupp_gce")
     * @Security("has_role('ROLE_ADMIN')")
     */
    public function ncfinvalidateAction()
    {
        return $this->render("Gceapp/index.html.twig");
    }

}