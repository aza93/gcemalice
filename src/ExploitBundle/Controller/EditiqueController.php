<?php
/**
 * Created by PhpStorm.
 * User: aboussadia
 * Date: 29/06/2018
 * Time: 09:50
 */

namespace ExploitBundle\Controller;

use Symfony\Bundle\FrameworkBundle\Controller\Controller;
use Sensio\Bundle\FrameworkExtraBundle\Configuration\Route;

class EditiqueController extends Controller
{

    /**
     * @Route("renduedi", name="Renduedi")
     */

    public function indexAction(){

        $rendu = $this->ediAction();


        return $rendu;
    }


    public function ediAction(){


        $srcfile="/tmp/montageBipbip/editique.log";
        $dstfile="/var/www/html/gcemalice/web/edi/editique.log";

        if (file_exists($dstfile)) {
//            fclose($dstfile);

            unlink($dstfile);

        } else {
            echo "Le fichier $dstfile n'est pas supprimé.";
        }
//
        if (!copy($srcfile, $dstfile)) {

            echo "La copie $srcfile du fichier a échoué...\n";
        }
        chmod($dstfile, 0755);
        $datedeb = date('M d ');
//        $datedeb = 'Jun 27';


        $fp = fopen($dstfile, "r");
        $x=0;
        $compteur_erreur = 0;
        $compteur_failed = 0;
        $editique = file($dstfile);

        $tab_erreur =[];
        $tab_failed =[];


        foreach( $editique as $line) // une boucle sur les ligne du fichier
        {
            if(strpos($line,'ERROR') && !strpos($line,'failed')) {   // recherche sur les lignes le mot Error sans Failed


                if( stristr($line, $datedeb) != null){
                    $lin = $x+1;                                    // ligne apres l'erreur
                    $cmd =  substr($editique[$lin],44, 9);  // extraire le numéroe de commande
                    $tab_erreur[] = $line ;
                    $tab_erreur[] =  $cmd ;
                    $compteur_erreur++; // compteur d'erreur
                }
            }
            if (strpos($line,'failed')){
                if( stristr($line, $datedeb) != null){          // date d'aujoud'hui
                    $lin = $x+1;   // la ligne apres le failed
                    $tab_failed[] = $line;  // ligne avec failed sur la ligne
                    $cmd =  substr($editique[$lin],44, 9);   // extraire le numéroe de commande
                    $tab_failed[] = $cmd;
                    $compteur_failed++; // compteur des failed


                }

            }
            $x = $x+1;
        };



        return  array(
            '_erreurs' => $tab_erreur,
            '_failed' => $tab_failed,
            'compteur_erreur' => $compteur_erreur,
            'compteur_failed' => $compteur_failed

        );

    }
    /**
     * @Route("edi", name="EdiConsult")
     */


    public function consultAction()
    {
        $rendu = $this->ediAction();


        return $this->render('@Exploit/Gceconsult/editique.html.twig', array(
            '_erreurs' =>  $rendu["_erreurs"],
            '_failed' => $rendu["_failed"]

        ));
    }

}