<?php
/**
 * Created by PhpStorm.
 * User: aboussadia
 * Date: 29/08/2018
 * Time: 10:32
 */

namespace ExploitBundle\Controller;


use ExploitBundle\Entity\User;
use Symfony\Bundle\FrameworkBundle\Controller\Controller;
use Sensio\Bundle\FrameworkExtraBundle\Configuration\Route;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\HttpFoundation\Session\Session;
use ExploitBundle\Repository\RequegceRepository;
use ExploitBundle\Resources\config\Connexion;

class MagappController extends Controller
{

    /**
     * @Route("/mag/impression", name="mag_index")
     */
    public function indexAction(Request $request , Session $session)
    {
        $ip =  $this->getIpAction();

        $connex = new Connexion();
        $con =  $connex->controle_file_gce();
        $con = $this->getDoctrine()->getEntityManager()->getConnection();

        if($ip == 11){
            $mag =   $con->executeQuery('SELECT code_mag from liste_mag');
        }else{
            $mag =   $con->executeQuery('SELECT code_mag from liste_mag WHERE reseau ='.$ip);
        }

        if(!empty($_POST['magasin'])){

        $magasin = $_POST['magasin'];

        if($magasin === 'TOUS'){
            $forMag ='';
        }else{
            $forMag = "and sigtie='".$magasin."'";
        }

        $sql ="DECLARE CURSOR c1 IS SELECT sigtie, nomtie, codzn5 FROM tie WHERE codsoc = 1 AND typtie = 'DEP' AND codzn6 IN ('COMP', 'TRAN', 'OUVE') ". $forMag. " ; BEGIN FOR cur1 IN c1 LOOP EDI_ETI_GOND_mag (2, cur1.sigtie, 100); END LOOP; END;";
        $req_plsql = oci_parse($con,$sql);
        $req_gce = oci_execute($req_plsql);

            $session->getFlashBag()->add('success', "Lancement des etiquettes vient d'étre effectuée  ");
        }

        $requgce = new RequegceRepository();

        return $this->render("mag/index.html.twig", array('mag' => $mag));
    }


    public function getIpAction() {
        // IP si internet partagé
        if (isset($_SERVER['HTTP_CLIENT_IP'])) {
            $ip = $_SERVER['HTTP_CLIENT_IP'];
        }
        // IP derrière un proxy
        elseif (isset($_SERVER['HTTP_X_FORWARDED_FOR'])) {
            $ip =  $_SERVER['HTTP_X_FORWARDED_FOR'];
        }
        // Sinon : IP normale
        else {

            $ip = isset($_SERVER['REMOTE_ADDR']) ? $_SERVER['REMOTE_ADDR'] : '';
        }
        $res = preg_split("/\.|:/",$ip);
        $var_ip =  $res[2];

        return $var_ip;

    }



}