<?php
/**
 * Created by PhpStorm.
 * User: aboussadia
 * Date: 08/04/2018
 * Time: 21:46
 */

namespace ExploitBundle\Controller;

use Symfony\Bundle\FrameworkBundle\Controller\Controller;
use Sensio\Bundle\FrameworkExtraBundle\Configuration\Route;
use ExploitBundle\Resources\config\Connexion;
use Symfony\Component\Config\Definition\Exception\Exception;

class ValidationController extends Controller
{

    /**
     * @Route("/validation/{sequence}/{id}", name="validate")
     */
    public function validerEnPlSql($id, $sequence)
    {
        $em = $this->getDoctrine()->getManager();
        $em->getRepository("ExploitBundle:Post")->updateStatut($id, 3); // update statut


        $connex = new Connexion();
        $con = $connex->controle_file_gce();

        // lancement du PLSQL
        $req_plsql = oci_parse($con, "CALL SOC2.wp_produit_integrer_v1()");

        $req_gce = oci_execute($req_plsql);

        if($req_gce){

            $resp_req =  $this->reponsePlSql($sequence); //Rep Table wt_produit

            return $this->render('preparation/validate.html.twig',array(
                'resp' => $resp_req
            ));

        }else{

            throw new Exception("L'intégration n'est pas validée");
        }




    }

    public function reponsePlSql($sequence)
    {

        $connex = new Connexion();
        $con = $connex->controle_file_gce();

        /* Requte réponse après plsql */
        $req_gce_fil =oci_parse($con, "select * from wt_produit_integrer_v1 where sequence = '$sequence'");
        oci_execute($req_gce_fil);
        oci_fetch_all($req_gce_fil, $res_req, null, null, OCI_FETCHSTATEMENT_BY_ROW);

        return $res_req;
    }

}