<?php
/**
 * Created by PhpStorm.
 * User: aboussadia
 * Date: 03/07/2018
 * Time: 11:18
 */

namespace ExploitBundle\Controller;


use ExploitBundle\Entity\Post;
use Symfony\Bundle\FrameworkBundle\Controller\Controller;
use Symfony\Component\HttpFoundation\Request;
use Sensio\Bundle\FrameworkExtraBundle\Configuration\Route;
use Symfony\Component\HttpFoundation\Session\Session;
use PhpOffice\PhpSpreadsheet\Writer;
use Symfony\Component\HttpFoundation\File\File;
use ExploitBundle\Resources\config\Connexion;


class GammeController extends Controller
{

    /**
     * @param Request $request
     * @return \Symfony\Component\HttpFoundation\RedirectResponse|\Symfony\Component\HttpFoundation\Response
     * @Route("/gamme/modif/", name="modif_gamme")
     */
    public function newAction(Request $request)
    {
        $session = new Session();
        $post = new Post();
        $form = $this->createForm('ExploitBundle\Form\PostType', $post);
        $form->handleRequest($request);
        $session->getFlashBag()->add('success', "AJOUTER UN FICHIER POUR CHANGEMENT DE GAMME");

        $form = $this->createForm('ExploitBundle\Form\PostType', $post);
        $form->handleRequest($request);

        if ($form->isSubmitted() && $form->isValid()) {
            $em = $this->getDoctrine()->getManager();
            $post->setUserId($this->getUser()->getId());
            $post->setGroupfile('gamme');
            $post->setUpdateAt(new \DateTime());
            $post->setStatut(1);
            $em->persist($post);
            $em->flush();

            return $this->redirectToRoute('modifgamme_prepa', array('id' => $post->getId(), 'filename' => $post->getFilename()));
        }

        return $this->render('gammechange/new.html.twig', array(
            'post' => $post,
            'form' => $form->createView(),
        ));

    }

    /**
     * @param Post $post
     * @return \Symfony\Component\HttpFoundation\Response
     * @throws Writer\Exception
     * @throws \PhpOffice\PhpSpreadsheet\Exception
     * @throws \PhpOffice\PhpSpreadsheet\Reader\Exception
     * @Route("/gamme/modif/{id}/", name="modifgamme_prepa")
     */
    public function prepaAction(Post $post)
    {

        $filePath =  $post->getFile()->getRealPath();   // path du fichier

        $file = new File($filePath);

        $reader = \PhpOffice\PhpSpreadsheet\IOFactory::createReaderForFile($filePath);
        $reader->setReadDataOnly(true);
        $spreadsheet = $reader->load($filePath);

        $lire = $spreadsheet->getActiveSheet()->getCellByColumnAndRow(1, 1)->getValue();
        $lire_ligne1000 = $spreadsheet->getActiveSheet()->getCellByColumnAndRow(1, 1001)->getValue();


        if($lire == 'CODPRO' && $lire_ligne1000 == '' ){


            $writer = new Writer\Csv($spreadsheet);
            $csv = $writer->save('../web/uploads/GAMME/fileCsv/'.$post->getFilename().'.csv');     // créer un csv



            return $this->render('gammechange/prepagamme.html.twig', array(
                'post' => $post,
            ));

        }else{
            $session = new Session();
            $session->getFlashBag()->add('danger', "Erreur sur le fichier Type ");

            return $this->render('produitsenvn/erreurvn.html.twig', array(
                'id' => $post->getId()
            ));
        }

    }

    /**
     * @param $id
     * @param $filename
     * @return \Symfony\Component\HttpFoundation\Response
     * @throws \Exception
     * @Route("/gamme/modif/{id}/{filename}/", name="modifgamme_csv")
     */
    public function conversionCsvAction($id, $filename)
    {

        $filePathCsv = realpath(dirname(__FILE__) . '/../../../web/uploads/GAMME/fileCsv/' . $filename . '.csv');

        if($filePathCsv){

            $em = $this->getDoctrine()->getManager();
            $statut = $em->getRepository("ExploitBundle:Post")->findStatut($id, 2);

            if($statut) throw new \Exception("Ce  fichier est Déja intégré");

            $csv = array_map('str_getcsv', file($filePathCsv));
            array_walk($csv, function (&$a) use ($csv) {
                $a = array_combine($csv[0], $a);//
            });
            array_shift($csv); # remove column header

            $action =  $this->traitementgammeAction($csv);

            $em->getRepository("ExploitBundle:Post")->updateStatut($id, 3); // update statut

            return $this->render('gammechange/validateGamme.html.twig', array('erreurs' => $action ));

        }else{
            throw new \Exception('Fichier introuvable');
        }
    }


    /**
     * @param $csv
     * @return array
     * @throws \Exception
     */
    public function traitementgammeAction($csv)
    {

        $connex = new Connexion();
        $cont = count($csv);
        $sql=[];
        $erreur_gamme=[];
        for ($i = 1; $i < $cont; $i++) {
            if ($csv[$i]['CODPRO'] != null) {
                $codpro= $csv[$i]['CODPRO'];
                $gamme = $csv[$i]['GAMME'];
                $gammearray = ['A','B','C','E','L','M','P','XS','Z'];
                if(in_array($gamme, $gammearray)){

                    if($codpro ==! NULL && is_numeric($codpro))
                        $sql[] = "UPDATE PRO SET CODZN7 ='$gamme', UTIMOD='GAMME', DATMOD = to_char(sysdate,'YYYYMMDD') WHERE CODSOC = 1 and CODPRO =  '$codpro'";

                }else{
                   $erreur_gamme[]= "La gamme $gamme n'existe pas, produit :  $codpro";
                }
            };
        };

        foreach ($sql as $req){

                $con = $connex->controle_file_gce();
                $req_gce = oci_parse($con, $req);
                if ($req_gce == false) {
                    throw new \Exception('Erreur Oracle De la mise à jour');
                } else {
                    oci_execute($req_gce);
                }
        }

        return $erreur_gamme;

    }


}